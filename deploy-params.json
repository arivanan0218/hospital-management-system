{
  "InstanceIds": ["i-0002b69cc4efed969"],
  "DocumentName": "AWS-RunShellScript",
  "TimeoutSeconds": 300,
  "Parameters": {
    "commands": [
      "echo '=== DEPLOYING FIXED VERSION ==='",
      "cd /home/ec2-user",
      "sudo rm -rf hospital-management",
      "mkdir -p hospital-management",
      "cd hospital-management",
      "echo 'Downloading latest fixed docker-compose.prod.yml:'",
      "curl -fsSL -o docker-compose.prod.yml https://raw.githubusercontent.com/arivanan0218/hospital-management-system/dev/docker-compose.prod.yml",
      "echo 'Verifying download:'",
      "ls -la docker-compose.prod.yml",
      "echo 'Content check:'",
      "grep -A 3 -B 3 '3000:80' docker-compose.prod.yml",
      "echo 'Logging into ECR:'",
      "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 324037286635.dkr.ecr.us-east-1.amazonaws.com",
      "echo 'Stopping existing containers:'",
      "docker stop $(docker ps -aq) 2>/dev/null || true",
      "docker rm $(docker ps -aq) 2>/dev/null || true",
      "echo 'Pulling latest images (with fixes):'",
      "docker pull 324037286635.dkr.ecr.us-east-1.amazonaws.com/hospital-backend:latest",
      "docker pull 324037286635.dkr.ecr.us-east-1.amazonaws.com/hospital-frontend:latest",
      "echo 'Starting containers:'",
      "AWS_ACCOUNT_ID=324037286635 AWS_REGION=us-east-1 IMAGE_TAG=latest POSTGRES_PASSWORD=Arivu2001 docker-compose -f docker-compose.prod.yml up -d",
      "echo 'Waiting for services to start:'",
      "sleep 45",
      "echo 'Container status:'",
      "docker ps",
      "echo 'Service health checks:'",
      "docker-compose -f docker-compose.prod.yml ps",
      "echo 'Testing connectivity:'",
      "curl -f http://localhost:80 && echo 'Port 80 OK' || echo 'Port 80 failed'",
      "curl -f http://localhost:3000 && echo 'Port 3000 OK' || echo 'Port 3000 failed'",
      "curl -f http://localhost:8000/health && echo 'Backend health OK' || echo 'Backend health failed'",
      "echo 'Deployment complete!'"
    ]
  }
}
