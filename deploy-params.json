{
  "InstanceIds": ["i-0002b69cc4efed969"],
  "DocumentName": "AWS-RunShellScript",
  "TimeoutSeconds": 300,
  "Parameters": {
    "commands": [
      "echo 'Setting up deployment environment...'",
      "cd /home/ec2-user",
      "rm -rf hospital-management",
      "mkdir -p hospital-management",
      "cd hospital-management",
      "echo 'Downloading docker-compose.prod.yml...'",
      "curl -fsSL -o docker-compose.prod.yml https://raw.githubusercontent.com/arivanan0218/hospital-management-system/dev/docker-compose.prod.yml",
      "echo 'Verifying file download:'",
      "ls -la docker-compose.prod.yml",
      "echo 'File content:'",
      "cat docker-compose.prod.yml",
      "echo 'Logging into ECR...'",
      "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 324037286635.dkr.ecr.us-east-1.amazonaws.com",
      "echo 'Stopping any existing containers...'",
      "docker stop $(docker ps -aq) 2>/dev/null || true",
      "docker rm $(docker ps -aq) 2>/dev/null || true",
      "echo 'Pulling images...'",
      "docker pull 324037286635.dkr.ecr.us-east-1.amazonaws.com/hospital-backend:latest",
      "docker pull 324037286635.dkr.ecr.us-east-1.amazonaws.com/hospital-frontend:latest",
      "echo 'Setting environment and starting containers...'",
      "export AWS_ACCOUNT_ID=324037286635",
      "export AWS_REGION=us-east-1",
      "export IMAGE_TAG=latest",
      "export POSTGRES_PASSWORD=Arivu2001",
      "docker-compose -f docker-compose.prod.yml up -d",
      "echo 'Waiting for containers to start...'",
      "sleep 20",
      "echo 'Final status check:'",
      "docker ps",
      "echo 'Port check:'",
      "ss -tlnp | grep -E ':3000|:8000' || echo 'No services on ports 3000/8000'",
      "echo 'Local connectivity test:'",
      "timeout 10 bash -c 'until curl -f http://localhost:3000; do sleep 1; done' || echo 'Frontend timeout'",
      "timeout 10 bash -c 'until curl -f http://localhost:8000; do sleep 1; done' || echo 'Backend timeout'"
    ]
  }
}
